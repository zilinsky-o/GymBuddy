<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GymBuddy v1.6.0</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }
        
        /* Disable text selection globally */
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Enable text selection for input fields */
        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        /* Custom slider styling */
        .slider {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }
        
        .slider::-webkit-slider-track {
            background: #d1d5db;
            height: 8px;
            border-radius: 4px;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981, #059669);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            border: 2px solid white;
        }
        
        .slider::-moz-range-track {
            background: #d1d5db;
            height: 8px;
            border-radius: 4px;
            border: none;
        }
        
        .slider::-moz-range-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981, #059669);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            border: 2px solid white;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAja3ry0NloNhpUeIC4_MBg-eR528OrJPE",
            authDomain: "gymbuddy-odedzi.firebaseapp.com",
            projectId: "gymbuddy-odedzi",
            storageBucket: "gymbuddy-odedzi.firebasestorage.app",
            messagingSenderId: "14645294833",
            appId: "1:14645294833:web:50ac4be9d92d0faf621b50"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Default exercises for routine A
        const DEFAULT_EXERCISES_A = [
            { name: 'Leg Extension', sets: 3, weight: 50, reps: 12 },
            { name: 'Leg Curl', sets: 3, weight: 37.5, reps: 15 },
            { name: 'Chest Press', sets: 3, weight: 35, reps: 12 },
            { name: 'Pulldown', sets: 3, weight: 47, reps: 10 },
            { name: 'Leg Press', sets: 3, weight: 40, reps: 14 },
            { name: 'Shoulder Press', sets: 3, weight: 22.5, reps: 12 },
            { name: 'Chest Pull', sets: 3, weight: 40, reps: 14 },
            { name: 'Hip Thrust', sets: 3, weight: 25, reps: 15 },
            { name: 'Pull Over', sets: 3, weight: 22.5, reps: 10 },
            { name: 'Rear Delt', sets: 3, weight: 18, reps: 9 },
            { name: 'Pec Fly', sets: 3, weight: 25, reps: 13 }
        ];

        // Randomized order for routine B
        const DEFAULT_EXERCISES_B = [
            { name: 'Shoulder Press', sets: 3, weight: 22.5, reps: 12 },
            { name: 'Leg Extension', sets: 3, weight: 50, reps: 12 },
            { name: 'Pull Over', sets: 3, weight: 22.5, reps: 10 },
            { name: 'Chest Press', sets: 3, weight: 35, reps: 12 },
            { name: 'Hip Thrust', sets: 3, weight: 25, reps: 15 },
            { name: 'Pec Fly', sets: 3, weight: 25, reps: 13 },
            { name: 'Leg Curl', sets: 3, weight: 37.5, reps: 15 },
            { name: 'Chest Pull', sets: 3, weight: 40, reps: 14 },
            { name: 'Rear Delt', sets: 3, weight: 18, reps: 9 },
            { name: 'Pulldown', sets: 3, weight: 47, reps: 10 },
            { name: 'Leg Press', sets: 3, weight: 40, reps: 14 }
        ];

        // Randomized order for Solo routine
        const DEFAULT_EXERCISES_SOLO = [
            { name: 'Pulldown', sets: 3, weight: 47, reps: 10 },
            { name: 'Hip Thrust', sets: 3, weight: 25, reps: 15 },
            { name: 'Leg Extension', sets: 3, weight: 50, reps: 12 },
            { name: 'Rear Delt', sets: 3, weight: 18, reps: 9 },
            { name: 'Leg Press', sets: 3, weight: 40, reps: 14 },
            { name: 'Pec Fly', sets: 3, weight: 25, reps: 13 },
            { name: 'Chest Press', sets: 3, weight: 35, reps: 12 },
            { name: 'Leg Curl', sets: 3, weight: 37.5, reps: 15 },
            { name: 'Shoulder Press', sets: 3, weight: 22.5, reps: 12 },
            { name: 'Pull Over', sets: 3, weight: 22.5, reps: 10 },
            { name: 'Chest Pull', sets: 3, weight: 40, reps: 14 }
        ];

        const ROUTINE_CONFIGS = {
            'A': { exercises: DEFAULT_EXERCISES_A, name: 'Full Body A', icon: 'ðŸ‘¥', label: 'A' },
            'B': { exercises: DEFAULT_EXERCISES_B, name: 'Full Body B', icon: 'ðŸ‘¥', label: 'B' },
            'Solo': { exercises: DEFAULT_EXERCISES_SOLO, name: 'Full Body Solo', icon: 'ðŸ‘¤', label: 'Solo' }
        };

        // Firebase data management functions
        const saveUserData = async (userId, data) => {
            try {
                await db.collection('users').doc(userId).set(data, { merge: true });
                console.log('Data saved successfully for user:', userId);
            } catch (error) {
                console.error('Error saving data:', error);
            }
        };

        const loadUserData = async (userId) => {
            try {
                const doc = await db.collection('users').doc(userId).get();
                if (doc.exists) {
                    return doc.data();
                } else {
                    console.log('No user data found for:', userId, 'using defaults');
                    return null;
                }
            } catch (error) {
                console.error('Error loading data:', error);
                return null;
            }
        };

        // User ID management functions
        const getCurrentUserId = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const userParam = urlParams.get('user');
            
            if (!userParam) {
                return 'default';
            }
            
            const normalized = userParam.toLowerCase().replace(/[^a-z0-9]/g, '');
            return normalized || 'default';
        };

        // RTL detection function
        const detectRTLFromURL = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const langParam = urlParams.get('lang');
            return langParam === 'ar' || langParam === 'he';
        };

        // Helper functions for session management
        const getTodayDateString = () => {
            const today = new Date();
            return today.getFullYear() + '-' + 
                   String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                   String(today.getDate()).padStart(2, '0');
        };

        const formatSessionDate = (dateString) => {
            const sessionDate = new Date(dateString + 'T00:00:00');
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            const startOfThisWeek = new Date(today);
            startOfThisWeek.setDate(today.getDate() - today.getDay());
            startOfThisWeek.setHours(0, 0, 0, 0);
            
            const startOfLastWeek = new Date(startOfThisWeek);
            startOfLastWeek.setDate(startOfThisWeek.getDate() - 7);
            
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            if (sessionDate.toDateString() === today.toDateString()) {
                return 'Today';
            }
            
            if (sessionDate.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            }
            
            if (sessionDate >= startOfThisWeek && sessionDate < today) {
                return `${dayNames[sessionDate.getDay()]}, earlier this week`;
            }
            
            if (sessionDate >= startOfLastWeek && sessionDate < startOfThisWeek) {
                return `${dayNames[sessionDate.getDay()]}, last week`;
            }
            
            const day = sessionDate.getDate();
            const month = sessionDate.getMonth() + 1;
            const year = String(sessionDate.getFullYear()).slice(-2);
            return `${dayNames[sessionDate.getDay()]}, ${day}/${month}/${year}`;
        };

        const hasSessionInteractions = (completedExercises, exerciseValues, startingValues) => {
            if (completedExercises.size > 0) {
                return true;
            }
            
            for (let index in exerciseValues) {
                const current = exerciseValues[index];
                const starting = startingValues[index];
                if (current.sets !== starting.sets || current.weight !== starting.weight || current.reps !== starting.reps) {
                    return true;
                }
            }
            
            return false;
        };

        // Inline SVG icons as React components
        const DumbbellIcon = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M14.4 14.4 9.6 9.6" />
                <path d="M18.657 21.485a2 2 0 1 1-2.829-2.828l-1.767 1.767a2 2 0 1 1-2.829-2.829l6.364-6.364a2 2 0 1 1 2.829 2.829l-1.768 1.767a2 2 0 1 1 2.829 2.828z" />
                <path d="m21.5 21.5-1.4-1.4" />
                <path d="M3.9 3.9 2.5 2.5" />
                <path d="M6.404 12.768a2 2 0 1 1-2.829-2.829l1.768-1.767a2 2 0 1 1-2.829-2.829l2.829-2.828a2 2 0 1 1 2.828 2.828l1.767-1.768a2 2 0 1 1 2.829 2.829z" />
            </svg>
        );

        const RepeatIcon = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="m3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" />
                <path d="M21 3v5h-5" />
                <path d="m21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" />
                <path d="M3 21v-5h5" />
            </svg>
        );

        const CheckIcon = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3">
                <polyline points="20,6 9,17 4,12" />
            </svg>
        );

        const EditIcon = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" />
                <path d="m15 5 4 4" />
            </svg>
        );

        const ChevronUpIcon = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="18,15 12,9 6,15" />
            </svg>
        );

        const ChevronDownIcon = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="6,9 12,15 18,9" />
            </svg>
        );

        const TrashIcon = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="3,6 5,6 21,6" />
                <path d="m19,6v14a2,2 0 0,1-2,2H7a2,2 0 0,1-2-2V6m3,0V4a2,2 0 0,1,2-2h4a2,2 0 0,1,2,2v2" />
            </svg>
        );

        const PlusIcon = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="12" y1="5" x2="12" y2="19" />
                <line x1="5" y1="12" x2="19" y2="12" />
            </svg>
        );

        const StackIcon = ({ className }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="3" y="4" width="18" height="4" rx="1" />
                <rect x="3" y="10" width="18" height="4" rx="1" />
                <rect x="3" y="16" width="18" height="4" rx="1" />
            </svg>
        );

        const GymBuddy = () => {
            const [currentRoutine, setCurrentRoutine] = useState('A');
            const [routines, setRoutines] = useState({
                'A': { exercises: DEFAULT_EXERCISES_A },
                'B': { exercises: DEFAULT_EXERCISES_B },
                'Solo': { exercises: DEFAULT_EXERCISES_SOLO }
            });
            const [completedExercises, setCompletedExercises] = useState(new Set());
            const [isDarkMode, setIsDarkMode] = useState(false);
            const [isRTL, setIsRTL] = useState(false);
            const [editingExercise, setEditingExercise] = useState(null);
            const [exerciseValues, setExerciseValues] = useState({});
            const [startingValues, setStartingValues] = useState({});
            const [sessionHistory, setSessionHistory] = useState([]);
            const [currentSessionDate, setCurrentSessionDate] = useState(getTodayDateString());
            const [isLoading, setIsLoading] = useState(true);
            const [saveStatus, setSaveStatus] = useState('');
            const [currentView, setCurrentView] = useState('main');
            const [selectedSession, setSelectedSession] = useState(null);
            const [currentUserId, setCurrentUserId] = useState(() => getCurrentUserId());
            const [editingProgramExercise, setEditingProgramExercise] = useState(null);
            const [highlightedExercise, setHighlightedExercise] = useState(null);

            // Set document direction based on RTL state
            useEffect(() => {
                document.documentElement.dir = isRTL ? 'rtl' : 'ltr';
            }, [isRTL]);

            // Get current exercises based on selected routine
            const currentExercises = routines[currentRoutine]?.exercises || DEFAULT_EXERCISES_A;

            // Initialize exercise values for current routine
            const initializeExerciseValues = (exercises) => {
                const values = {};
                const starting = {};
                
                exercises.forEach((exercise, index) => {
                    values[index] = {
                        sets: exercise.sets || 3,
                        weight: exercise.weight,
                        reps: exercise.reps
                    };
                    starting[index] = {
                        sets: exercise.sets || 3,
                        weight: exercise.weight,
                        reps: exercise.reps
                    };
                });
                
                return { values, starting };
            };

            // Update exercise values when routine changes
            useEffect(() => {
                const { values, starting } = initializeExerciseValues(currentExercises);
                setExerciseValues(values);
                setStartingValues(starting);
                setCompletedExercises(new Set());
            }, [currentRoutine, routines]);

            // Load data on component mount
            useEffect(() => {
                const loadData = async () => {
                    try {
                        const userData = await loadUserData(currentUserId);
                        const today = getTodayDateString();
                        
                        // Check URL for RTL parameter first
                        const urlRTL = detectRTLFromURL();
                        
                        if (userData) {
                            // Load routines if they exist
                            if (userData.routines) {
                                setRoutines(userData.routines);
                            }
                            
                            // Load current routine
                            if (userData.currentRoutine) {
                                setCurrentRoutine(userData.currentRoutine);
                            }
                            
                            // Load settings
                            if (userData.settings) {
                                setIsDarkMode(userData.settings.darkMode || false);
                                // Set RTL from URL parameter if present, otherwise from saved settings
                                setIsRTL(urlRTL || userData.settings.isRTL || false);
                            } else {
                                // Set RTL from URL parameter for new users
                                setIsRTL(urlRTL);
                            }
                            
                            // Load session history
                            if (userData.sessionHistory) {
                                setSessionHistory(userData.sessionHistory);
                            }
                            
                            // Check if it's a new day
                            const lastSessionDate = userData.currentSession?.sessionDate;
                            const isNewDay = lastSessionDate && lastSessionDate !== today;
                            
                            if (isNewDay) {
                                console.log('New day detected, checking for session to save');
                                
                                const prevCompleted = new Set(userData.currentSession?.completedExercises || []);
                                const prevValues = userData.currentSession?.modifiedValues || {};
                                const prevStarting = userData.currentSession?.startingValues || {};
                                
                                if (hasSessionInteractions(prevCompleted, prevValues, prevStarting)) {
                                    console.log('Previous session had interactions, saving to history');
                                    
                                    const sessionToSave = {
                                        date: lastSessionDate,
                                        routine: userData.currentSession?.routine || 'A',
                                        completedExercises: Array.from(prevCompleted),
                                        finalValues: prevValues,
                                        startingValues: prevStarting
                                    };
                                    
                                    const newHistory = [...(userData.sessionHistory || []), sessionToSave];
                                    setSessionHistory(newHistory);
                                    
                                    const { values, starting } = initializeExerciseValues(currentExercises);
                                    setExerciseValues(values);
                                    setStartingValues(starting);
                                    
                                    setCompletedExercises(new Set());
                                    setCurrentSessionDate(today);
                                    
                                    await saveUserData(currentUserId, {
                                        ...userData,
                                        sessionHistory: newHistory,
                                        currentSession: {
                                            completedExercises: [],
                                            modifiedValues: values,
                                            startingValues: starting,
                                            sessionDate: today,
                                            routine: currentRoutine
                                        }
                                    });
                                } else {
                                    console.log('Previous session had no interactions, not saving');
                                    
                                    const { values, starting } = initializeExerciseValues(currentExercises);
                                    setExerciseValues(values);
                                    setStartingValues(starting);
                                    
                                    setCompletedExercises(new Set());
                                    setCurrentSessionDate(today);
                                }
                            } else {
                                // Same day, load current session
                                if (userData.currentSession) {
                                    if (userData.currentSession.completedExercises) {
                                        setCompletedExercises(new Set(userData.currentSession.completedExercises));
                                    }
                                    if (userData.currentSession.modifiedValues) {
                                        setExerciseValues(userData.currentSession.modifiedValues);
                                    }
                                    if (userData.currentSession.startingValues) {
                                        setStartingValues(userData.currentSession.startingValues);
                                    }
                                    if (userData.currentSession.sessionDate) {
                                        setCurrentSessionDate(userData.currentSession.sessionDate);
                                    }
                                    if (userData.currentSession.routine) {
                                        setCurrentRoutine(userData.currentSession.routine);
                                    }
                                }
                            }
                        } else {
                            setCurrentSessionDate(today);
                            setIsRTL(urlRTL);
                            const { values, starting } = initializeExerciseValues(currentExercises);
                            setExerciseValues(values);
                            setStartingValues(starting);
                        }
                    } catch (error) {
                        console.error('Error loading data:', error);
                    } finally {
                        setIsLoading(false);
                    }
                };
                
                loadData();
            }, [currentUserId]);

            // Handle URL parameter changes
            useEffect(() => {
                const handleUrlChange = () => {
                    const newUserId = getCurrentUserId();
                    const newRTL = detectRTLFromURL();
                    
                    if (newUserId !== currentUserId) {
                        setCurrentUserId(newUserId);
                        setIsLoading(true);
                    }
                    
                    if (newRTL !== isRTL) {
                        setIsRTL(newRTL);
                    }
                };

                window.addEventListener('popstate', handleUrlChange);
                return () => window.removeEventListener('popstate', handleUrlChange);
            }, [currentUserId, isRTL]);

            // Save data function with debouncing
            useEffect(() => {
                if (isLoading) return;
                
                const saveData = async () => {
                    try {
                        setSaveStatus('saving');
                        const dataToSave = {
                            settings: {
                                darkMode: isDarkMode,
                                isRTL: isRTL,
                                lastUsed: firebase.firestore.Timestamp.now()
                            },
                            currentRoutine: currentRoutine,
                            routines: routines,
                            currentSession: {
                                completedExercises: Array.from(completedExercises),
                                modifiedValues: exerciseValues,
                                startingValues: startingValues,
                                sessionDate: currentSessionDate,
                                routine: currentRoutine
                            },
                            sessionHistory: sessionHistory
                        };
                        
                        await saveUserData(currentUserId, dataToSave);
                        setSaveStatus('saved');
                        setTimeout(() => setSaveStatus(''), 2000);
                    } catch (error) {
                        console.error('Error saving data:', error);
                        setSaveStatus('error');
                        setTimeout(() => setSaveStatus(''), 3000);
                    }
                };

                const timeoutId = setTimeout(saveData, 1000);
                return () => clearTimeout(timeoutId);
            }, [completedExercises, isDarkMode, isRTL, exerciseValues, startingValues, currentSessionDate, sessionHistory, routines, currentRoutine, currentUserId, isLoading]);

            const toggleExercise = (index) => {
                const newCompleted = new Set(completedExercises);
                if (newCompleted.has(index)) {
                    newCompleted.delete(index);
                } else {
                    newCompleted.add(index);
                }
                setCompletedExercises(newCompleted);
            };

            const toggleDarkMode = () => {
                setIsDarkMode(!isDarkMode);
            };

            const switchRoutine = (routineId) => {
                setCurrentRoutine(routineId);
                setEditingExercise(null);
                setEditingProgramExercise(null);
            };

            const startEditing = (index, type) => {
                const originalValue = currentExercises[index][type];
                setEditingExercise({
                    index,
                    type,
                    value: exerciseValues[index][type],
                    original: originalValue
                });
            };

            const updateEditValue = (newValue) => {
                setEditingExercise(prev => ({
                    ...prev,
                    value: newValue
                }));
            };

            const finishEditing = () => {
                if (editingExercise) {
                    setExerciseValues(prev => ({
                        ...prev,
                        [editingExercise.index]: {
                            ...prev[editingExercise.index],
                            [editingExercise.type]: editingExercise.value
                        }
                    }));
                }
                setEditingExercise(null);
            };

            const getValueRange = (originalValue, type = 'reps') => {
                if (type === 'sets') {
                    return { min: 1, max: 5, step: 1 };
                }
                
                const isWeight = type === 'weight';
                const range = Math.round(originalValue * 0.5);
                const min = Math.max(0, originalValue - range);
                const max = originalValue + range;
                const step = isWeight ? 0.5 : 1;
                return { min, max, step };
            };

            const formatWeight = (weight) => {
                return weight.toFixed(1);
            };

            // Program editing functions
            const moveExerciseUp = (index) => {
                if (index > 0) {
                    const newExercises = [...currentExercises];
                    [newExercises[index - 1], newExercises[index]] = [newExercises[index], newExercises[index - 1]];
                    
                    setRoutines(prev => ({
                        ...prev,
                        [currentRoutine]: { exercises: newExercises }
                    }));
                    
                    setHighlightedExercise(index - 1);
                    setTimeout(() => setHighlightedExercise(null), 1000);
                }
            };

            const moveExerciseDown = (index) => {
                if (index < currentExercises.length - 1) {
                    const newExercises = [...currentExercises];
                    [newExercises[index], newExercises[index + 1]] = [newExercises[index + 1], newExercises[index]];
                    
                    setRoutines(prev => ({
                        ...prev,
                        [currentRoutine]: { exercises: newExercises }
                    }));
                    
                    setHighlightedExercise(index + 1);
                    setTimeout(() => setHighlightedExercise(null), 1000);
                }
            };

            const deleteExercise = (index) => {
                if (confirm('Are you sure you want to delete this exercise?')) {
                    const newExercises = currentExercises.filter((_, i) => i !== index);
                    setRoutines(prev => ({
                        ...prev,
                        [currentRoutine]: { exercises: newExercises }
                    }));
                }
            };

            const startEditingProgramExercise = (index) => {
                setEditingProgramExercise({
                    index,
                    name: currentExercises[index].name,
                    sets: currentExercises[index].sets,
                    weight: currentExercises[index].weight,
                    reps: currentExercises[index].reps
                });
            };

            const updateProgramExercise = (field, value) => {
                setEditingProgramExercise(prev => ({
                    ...prev,
                    [field]: value
                }));
            };

            const saveProgramExercise = () => {
                if (editingProgramExercise) {
                    const newExercises = [...currentExercises];
                    newExercises[editingProgramExercise.index] = {
                        name: editingProgramExercise.name.trim() || 'Unnamed Exercise',
                        sets: Math.max(1, Math.min(5, editingProgramExercise.sets)),
                        weight: Math.max(0, editingProgramExercise.weight),
                        reps: Math.max(0, editingProgramExercise.reps)
                    };
                    
                    setRoutines(prev => ({
                        ...prev,
                        [currentRoutine]: { exercises: newExercises }
                    }));
                    
                    setEditingProgramExercise(null);
                }
            };

            const cancelEditingProgramExercise = () => {
                setEditingProgramExercise(null);
            };

            const addNewExercise = () => {
                const newExercise = {
                    name: 'New Exercise',
                    sets: 3,
                    weight: 0,
                    reps: 0
                };
                const newExercises = [...currentExercises, newExercise];
                
                setRoutines(prev => ({
                    ...prev,
                    [currentRoutine]: { exercises: newExercises }
                }));
                
                setTimeout(() => {
                    startEditingProgramExercise(newExercises.length - 1);
                }, 100);
            };

            const completedCount = completedExercises.size;

            // Show loading screen while data loads
            if (isLoading) {
                return React.createElement('div', {
                    className: `min-h-screen flex items-center justify-center transition-all duration-500 ${
                        isDarkMode 
                            ? 'bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900' 
                            : 'bg-gradient-to-br from-indigo-50 via-white to-pink-50'
                    }`
                },
                    React.createElement('div', { className: 'text-center' },
                        React.createElement('div', { 
                            className: `w-12 h-12 border-4 rounded-full animate-spin mx-auto mb-4 ${
                                isDarkMode 
                                    ? 'border-slate-600 border-t-blue-400' 
                                    : 'border-indigo-300 border-t-indigo-600'
                            }`
                        }),
                        React.createElement('h2', { 
                            className: `text-xl font-semibold ${
                                isDarkMode ? 'text-white' : 'text-slate-700'
                            }`
                        }, 'Loading GymBuddy...'),
                        React.createElement('p', { 
                            className: `mt-2 ${
                                isDarkMode ? 'text-slate-400' : 'text-slate-500'
                            }`
                        }, 'Syncing your workout data')
                    )
                );
            }

            // Program Edit Screen
            if (currentView === 'editProgram') {
                return React.createElement('div', {
                    className: `min-h-screen p-3 transition-all duration-500 ${
                        isDarkMode 
                            ? 'bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900' 
                            : 'bg-gradient-to-br from-indigo-50 via-white to-pink-50'
                    }`
                },
                    React.createElement('div', { className: 'text-center mb-6' },
                        React.createElement('div', { className: `flex items-center ${isRTL ? 'flex-row-reverse' : ''} justify-between mb-4` },
                            React.createElement('button', {
                                onClick: () => {
                                    setCurrentView('main');
                                    setEditingProgramExercise(null);
                                },
                                className: `px-4 py-2 rounded-lg transition-colors duration-300 ${
                                    isDarkMode 
                                        ? 'bg-slate-700 text-white hover:bg-slate-600' 
                                        : 'bg-white text-slate-700 hover:bg-gray-50'
                                } shadow-sm`
                            }, isRTL ? 'â†’ Back' : 'â† Back'),
                            React.createElement('h1', { 
                                className: `text-2xl font-bold ${isDarkMode ? 'text-white' : 'text-slate-800'}`
                            }, 
                                React.createElement('div', { className: `flex items-center justify-center ${isRTL ? 'flex-row-reverse' : ''} space-x-2 ${isRTL ? 'space-x-reverse' : ''}` },
                                    React.createElement('span', { className: 'text-2xl' }, ROUTINE_CONFIGS[currentRoutine].icon),
                                    React.createElement('span', {}, `Edit ${ROUTINE_CONFIGS[currentRoutine].name}`)
                                )
                            ),
                            React.createElement('div', { className: 'w-16' })
                        )
                    ),

                    React.createElement('div', { className: 'max-w-lg mx-auto space-y-3' },
                        currentExercises.map((exercise, index) => {
                            const isBeingEdited = editingProgramExercise?.index === index;
                            
                            if (isBeingEdited) {
                                return React.createElement('div', {
                                    key: index,
                                    className: `rounded-2xl p-4 shadow-lg border-2 transition-all duration-300 ${
                                        isDarkMode
                                            ? 'bg-slate-800 border-blue-500'
                                            : 'bg-white border-indigo-300'
                                    }`
                                },
                                    React.createElement('div', { className: 'space-y-4' },
                                        React.createElement('input', {
                                            type: 'text',
                                            value: editingProgramExercise.name,
                                            onChange: (e) => updateProgramExercise('name', e.target.value),
                                            onFocus: (e) => {
                                                if (e.target.value === 'New Exercise') {
                                                    updateProgramExercise('name', '');
                                                }
                                            },
                                            className: `w-full px-3 py-2 rounded-lg border text-center font-bold ${
                                                isDarkMode 
                                                    ? 'bg-slate-700 border-slate-600 text-white' 
                                                    : 'bg-white border-gray-300 text-slate-800'
                                            }`,
                                            placeholder: 'Exercise name'
                                        }),
                                        
                                        React.createElement('div', { className: `flex ${isRTL ? 'flex-row-reverse' : ''} space-x-3 ${isRTL ? 'space-x-reverse' : ''}` },
                                            React.createElement('div', { className: 'flex-1' },
                                                React.createElement('label', { 
                                                    className: `block text-sm font-medium mb-1 ${isRTL ? 'text-right' : 'text-left'} ${
                                                        isDarkMode ? 'text-slate-300' : 'text-slate-700'
                                                    }`
                                                }, 'Sets'),
                                                React.createElement('input', {
                                                    type: 'number',
                                                    min: '1',
                                                    max: '5',
                                                    value: editingProgramExercise.sets,
                                                    onChange: (e) => updateProgramExercise('sets', parseInt(e.target.value) || 1),
                                                    onFocus: (e) => {
                                                        if (e.target.value === '3') {
                                                            updateProgramExercise('sets', '');
                                                        }
                                                    },
                                                    className: `w-full px-3 py-2 rounded-lg border text-center ${
                                                        isDarkMode 
                                                            ? 'bg-slate-700 border-slate-600 text-white' 
                                                            : 'bg-white border-gray-300 text-slate-800'
                                                    }`
                                                })
                                            ),
                                            
                                            React.createElement('div', { className: 'flex-1' },
                                                React.createElement('label', { 
                                                    className: `block text-sm font-medium mb-1 ${isRTL ? 'text-right' : 'text-left'} ${
                                                        isDarkMode ? 'text-slate-300' : 'text-slate-700'
                                                    }`
                                                }, 'Weight (kg)'),
                                                React.createElement('input', {
                                                    type: 'number',
                                                    step: '0.5',
                                                    min: '0',
                                                    value: editingProgramExercise.weight,
                                                    onChange: (e) => updateProgramExercise('weight', parseFloat(e.target.value) || 0),
                                                    onFocus: (e) => {
                                                        if (e.target.value === '0') {
                                                            updateProgramExercise('weight', '');
                                                        }
                                                    },
                                                    className: `w-full px-3 py-2 rounded-lg border text-center ${
                                                        isDarkMode 
                                                            ? 'bg-slate-700 border-slate-600 text-white' 
                                                            : 'bg-white border-gray-300 text-slate-800'
                                                    }`
                                                })
                                            ),
                                            
                                            React.createElement('div', { className: 'flex-1' },
                                                React.createElement('label', { 
                                                    className: `block text-sm font-medium mb-1 ${isRTL ? 'text-right' : 'text-left'} ${
                                                        isDarkMode ? 'text-slate-300' : 'text-slate-700'
                                                    }`
                                                }, 'Reps'),
                                                React.createElement('input', {
                                                    type: 'number',
                                                    min: '0',
                                                    value: editingProgramExercise.reps,
                                                    onChange: (e) => updateProgramExercise('reps', parseInt(e.target.value) || 0),
                                                    onFocus: (e) => {
                                                        if (e.target.value === '0') {
                                                            updateProgramExercise('reps', '');
                                                        }
                                                    },
                                                    className: `w-full px-3 py-2 rounded-lg border text-center ${
                                                        isDarkMode 
                                                            ? 'bg-slate-700 border-slate-600 text-white' 
                                                            : 'bg-white border-gray-300 text-slate-800'
                                                    }`
                                                })
                                            )
                                        ),
                                        
                                        React.createElement('div', { className: `flex ${isRTL ? 'flex-row-reverse' : ''} space-x-2 ${isRTL ? 'space-x-reverse' : ''}` },
                                            React.createElement('button', {
                                                onClick: saveProgramExercise,
                                                className: `flex-1 px-4 py-2 rounded-lg transition-colors duration-300 ${
                                                    isDarkMode 
                                                        ? 'bg-green-600 text-white hover:bg-green-500' 
                                                        : 'bg-green-500 text-white hover:bg-green-600'
                                                }`
                                            }, 'Save'),
                                            React.createElement('button', {
                                                onClick: cancelEditingProgramExercise,
                                                className: `flex-1 px-4 py-2 rounded-lg transition-colors duration-300 ${
                                                    isDarkMode 
                                                        ? 'bg-slate-600 text-white hover:bg-slate-500' 
                                                        : 'bg-gray-500 text-white hover:bg-gray-600'
                                                }`
                                            }, 'Cancel')
                                        )
                                    )
                                );
                            }
                            
                            return React.createElement('div', {
                                key: index,
                                className: `rounded-2xl p-4 shadow-lg border transition-all duration-300 ${
                                    highlightedExercise === index ? 'ring-2 ring-blue-400 bg-blue-50/50' : ''
                                } ${
                                    isDarkMode
                                        ? `bg-slate-800/80 border-slate-700 ${
                                            highlightedExercise === index ? 'ring-blue-400 bg-blue-900/20' : ''
                                        }`
                                        : 'bg-white border-gray-100'
                                }`
                            },
                                React.createElement('div', { className: `flex items-center ${isRTL ? 'flex-row-reverse' : ''} space-x-4 ${isRTL ? 'space-x-reverse' : ''}` },
                                    // Up/Down buttons - positioned based on RTL
                                    React.createElement('div', { className: 'flex flex-col space-y-1' },
                                        React.createElement('button', {
                                            onClick: () => moveExerciseUp(index),
                                            disabled: index === 0,
                                            className: `p-2 rounded-lg transition-colors duration-300 ${
                                                index === 0 
                                                    ? 'opacity-30 cursor-not-allowed' 
                                                    : isDarkMode 
                                                        ? 'text-slate-400 hover:text-white hover:bg-slate-700' 
                                                        : 'text-slate-500 hover:text-slate-700 hover:bg-gray-100'
                                            }`
                                        },
                                            React.createElement(ChevronUpIcon, { className: 'w-5 h-5' })
                                        ),
                                        
                                        React.createElement('button', {
                                            onClick: () => moveExerciseDown(index),
                                            disabled: index === currentExercises.length - 1,
                                            className: `p-2 rounded-lg transition-colors duration-300 ${
                                                index === currentExercises.length - 1 
                                                    ? 'opacity-30 cursor-not-allowed' 
                                                    : isDarkMode 
                                                        ? 'text-slate-400 hover:text-white hover:bg-slate-700' 
                                                        : 'text-slate-500 hover:text-slate-700 hover:bg-gray-100'
                                            }`
                                        },
                                            React.createElement(ChevronDownIcon, { className: 'w-5 h-5' })
                                        )
                                    ),
                                    
                                    // Exercise info and controls
                                    React.createElement('div', { className: 'flex-1' },
                                        React.createElement('div', { className: `flex items-center ${isRTL ? 'flex-row-reverse' : ''} justify-between mb-3` },
                                            React.createElement('h3', { 
                                                className: `text-lg font-bold ${isRTL ? 'text-right' : 'text-left'} ${isDarkMode ? 'text-white' : 'text-slate-800'}`
                                            }, exercise.name),
                                            
                                            React.createElement('div', { className: `flex items-center ${isRTL ? 'flex-row-reverse' : ''} space-x-2 ${isRTL ? 'space-x-reverse' : ''}` },
                                                React.createElement('button', {
                                                    onClick: () => startEditingProgramExercise(index),
                                                    className: `p-2 rounded-lg transition-colors duration-300 ${
                                                        isDarkMode 
                                                            ? 'text-blue-400 hover:text-blue-300 hover:bg-slate-700' 
                                                            : 'text-blue-500 hover:text-blue-600 hover:bg-blue-50'
                                                    }`
                                                },
                                                    React.createElement(EditIcon, { className: 'w-5 h-5' })
                                                ),
                                                
                                                React.createElement('button', {
                                                    onClick: () => deleteExercise(index),
                                                    className: `p-2 rounded-lg transition-colors duration-300 ${
                                                        isDarkMode 
                                                            ? 'text-red-400 hover:text-red-300 hover:bg-slate-700' 
                                                            : 'text-red-500 hover:text-red-600 hover:bg-red-50'
                                                    }`
                                                },
                                                    React.createElement(TrashIcon, { className: 'w-5 h-5' })
                                                )
                                            )
                                        ),
                                        
                                        React.createElement('div', { className: `flex ${isRTL ? 'justify-start flex-row-reverse' : 'justify-end'} space-x-3 ${isRTL ? 'space-x-reverse' : ''}` },
                                            React.createElement('div', { 
                                                className: `flex items-center space-x-2 ${isRTL ? 'space-x-reverse flex-row-reverse' : ''} px-3 py-2 rounded-xl shadow-sm ${
                                                    isDarkMode ? 'bg-purple-900/50' : 'bg-purple-100'
                                                }`
                                            },
                                                React.createElement(StackIcon, { 
                                                    className: `w-4 h-4 ${isDarkMode ? 'text-purple-400' : 'text-purple-600'}`
                                                }),
                                                React.createElement('span', { 
                                                    className: `font-bold text-sm ${
                                                        isDarkMode ? 'text-purple-300' : 'text-purple-800'
                                                    }`
                                                }, `${exercise.sets}`)
                                            ),
                                            
                                            React.createElement('div', { 
                                                className: `flex items-center space-x-2 ${isRTL ? 'space-x-reverse flex-row-reverse' : ''} px-3 py-2 rounded-xl shadow-sm ${
                                                    isDarkMode ? 'bg-orange-900/50' : 'bg-orange-100'
                                                }`
                                            },
                                                React.createElement(DumbbellIcon, { 
                                                    className: `w-4 h-4 ${isDarkMode ? 'text-orange-400' : 'text-orange-600'}`
                                                }),
                                                React.createElement('span', { 
                                                    className: `font-bold text-sm ${
                                                        isDarkMode ? 'text-orange-300' : 'text-orange-800'
                                                    }`
                                                }, `${formatWeight(exercise.weight)}kg`)
                                            ),
                                            
                                            React.createElement('div', { 
                                                className: `flex items-center space-x-2 ${isRTL ? 'space-x-reverse flex-row-reverse' : ''} px-3 py-2 rounded-xl shadow-sm ${
                                                    isDarkMode ? 'bg-blue-900/50' : 'bg-blue-100'
                                                }`
                                            },
                                                React.createElement(RepeatIcon, { 
                                                    className: `w-4 h-4 ${isDarkMode ? 'text-blue-400' : 'text-blue-600'}`
                                                }),
                                                React.createElement('span', { 
                                                    className: `font-bold text-sm ${
                                                        isDarkMode ? 'text-blue-300' : 'text-blue-800'
                                                    }`
                                                }, `${exercise.reps}x`)
                                            )
                                        )
                                    )
                                )
                            );
                        }),
                        
                        // Add New Exercise Button
                        React.createElement('button', {
                            onClick: addNewExercise,
                            className: `w-full rounded-2xl p-4 border-2 border-dashed transition-all duration-300 hover:scale-105 ${
                                isDarkMode 
                                    ? 'border-slate-600 text-slate-400 hover:border-slate-500 hover:text-slate-300 hover:bg-slate-800/50' 
                                    : 'border-gray-300 text-gray-500 hover:border-gray-400 hover:text-gray-600 hover:bg-gray-50'
                            }`
                        },
                            React.createElement('div', { className: `flex items-center justify-center ${isRTL ? 'flex-row-reverse' : ''} space-x-2 ${isRTL ? 'space-x-reverse' : ''}` },
                                React.createElement(PlusIcon, { className: 'w-5 h-5' }),
                                React.createElement('span', { className: 'font-medium' }, 'Add New Exercise')
                            )
                        )
                    )
                );
            }

            // History List Screen
            if (currentView === 'history') {
                return React.createElement('div', {
                    className: `min-h-screen p-3 transition-all duration-500 ${
                        isDarkMode 
                            ? 'bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900' 
                            : 'bg-gradient-to-br from-indigo-50 via-white to-pink-50'
                    }`
                },
                    React.createElement('div', { className: 'text-center mb-6' },
                        React.createElement('div', { className: `flex items-center ${isRTL ? 'flex-row-reverse' : ''} justify-between mb-4` },
                            React.createElement('button', {
                                onClick: () => setCurrentView('main'),
                                className: `px-4 py-2 rounded-lg transition-colors duration-300 ${
                                    isDarkMode 
                                        ? 'bg-slate-700 text-white hover:bg-slate-600' 
                                        : 'bg-white text-slate-700 hover:bg-gray-50'
                                } shadow-sm`
                            }, isRTL ? 'â†’ Back' : 'â† Back'),
                            React.createElement('h1', { 
                                className: `text-2xl font-bold ${isDarkMode ? 'text-white' : 'text-slate-800'}`
                            }, 'Workout History'),
                            React.createElement('div', { className: 'w-16' })
                        )
                    ),

                    React.createElement('div', { className: 'max-w-lg mx-auto space-y-3' },
                        sessionHistory.length === 0 
                            ? React.createElement('div', { 
                                className: `text-center py-12 ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`
                            }, 'No workout history yet. Complete your first session to see it here!')
                            : sessionHistory.slice().reverse().map((session, index) => {
                                const completedCount = session.completedExercises.length;
                                const routineConfig = ROUTINE_CONFIGS[session.routine || 'A'];
                                
                                return React.createElement('div', {
                                    key: session.date,
                                    className: `rounded-2xl p-4 shadow-lg border transition-all duration-300 ${
                                        isDarkMode
                                            ? 'bg-slate-800/80 border-slate-700'
                                            : 'bg-white border-gray-100'
                                    }`
                                },
                                    React.createElement('div', { className: `flex items-center ${isRTL ? 'flex-row-reverse' : ''} justify-between` },
                                        React.createElement('div', {},
                                            React.createElement('div', { className: `flex items-center ${isRTL ? 'flex-row-reverse' : ''} space-x-2 ${isRTL ? 'space-x-reverse' : ''} mb-1` },
                                                React.createElement('span', { className: 'text-lg' }, routineConfig.icon),
                                                React.createElement('h3', { 
                                                    className: `font-semibold ${isRTL ? 'text-right' : 'text-left'} ${isDarkMode ? 'text-white' : 'text-slate-800'}`
                                                }, formatSessionDate(session.date)),
                                                React.createElement('span', { 
                                                    className: `text-xs px-2 py-1 rounded-full ${
                                                        isDarkMode ? 'bg-slate-700 text-slate-300' : 'bg-gray-100 text-gray-600'
                                                    }`
                                                }, routineConfig.name)
                                            ),
                                            React.createElement('p', { 
                                                className: `text-sm ${isRTL ? 'text-right' : 'text-left'} ${isDarkMode ? 'text-slate-400' : 'text-slate-600'}`
                                            }, `${completedCount} exercises completed`)
                                        ),
                                        React.createElement('button', {
                                            onClick: () => {
                                                setSelectedSession(session);
                                                setCurrentView('sessionDetail');
                                            },
                                            className: `px-4 py-2 rounded-lg text-sm transition-colors duration-300 ${
                                                isDarkMode 
                                                    ? 'bg-indigo-600 text-white hover:bg-indigo-500' 
                                                    : 'bg-indigo-100 text-indigo-700 hover:bg-indigo-200'
                                            }`
                                        }, 'View')
                                    )
                                );
                            })
                    )
                );
            }

            // Session Detail Screen
            if (currentView === 'sessionDetail' && selectedSession) {
                const routineConfig = ROUTINE_CONFIGS[selectedSession.routine || 'A'];
                const sessionExercises = routines[selectedSession.routine || 'A']?.exercises || DEFAULT_EXERCISES_A;
                
                return React.createElement('div', {
                    className: `min-h-screen p-3 transition-all duration-500 ${
                        isDarkMode 
                            ? 'bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900' 
                            : 'bg-gradient-to-br from-indigo-50 via-white to-pink-50'
                    }`
                },
                    React.createElement('div', { className: 'text-center mb-6' },
                        React.createElement('div', { className: `flex items-center ${isRTL ? 'flex-row-reverse' : ''} justify-between mb-4` },
                            React.createElement('button', {
                                onClick: () => setCurrentView('history'),
                                className: `px-4 py-2 rounded-lg transition-colors duration-300 ${
                                    isDarkMode 
                                        ? 'bg-slate-700 text-white hover:bg-slate-600' 
                                        : 'bg-white text-slate-700 hover:bg-gray-50'
                                } shadow-sm`
                            }, isRTL ? 'â†’ Back' : 'â† Back'),
                            React.createElement('div', { className: 'text-center' },
                                React.createElement('div', { className: `flex items-center justify-center ${isRTL ? 'flex-row-reverse' : ''} space-x-2 ${isRTL ? 'space-x-reverse' : ''} mb-1` },
                                    React.createElement('span', { className: 'text-xl' }, routineConfig.icon),
                                    React.createElement('h1', { 
                                        className: `text-2xl font-bold ${isDarkMode ? 'text-white' : 'text-slate-800'}`
                                    }, formatSessionDate(selectedSession.date))
                                ),
                                React.createElement('span', { 
                                    className: `text-sm px-3 py-1 rounded-full ${
                                        isDarkMode ? 'bg-slate-700 text-slate-300' : 'bg-gray-100 text-gray-600'
                                    }`
                                }, routineConfig.name)
                            ),
                            React.createElement('div', { className: 'w-16' })
                        )
                    ),

                    React.createElement('div', { className: 'max-w-lg mx-auto grid grid-cols-1 gap-3' },
                        selectedSession.completedExercises.map(exerciseIndex => {
                            const exercise = sessionExercises[exerciseIndex] || { name: 'Unknown Exercise', sets: 3, weight: 0, reps: 0 };
                            const finalValues = selectedSession.finalValues[exerciseIndex] || {
                                sets: exercise.sets,
                                weight: exercise.weight,
                                reps: exercise.reps
                            };

                            return React.createElement('div', {
                                key: exerciseIndex,
                                className: `rounded-2xl p-4 shadow-lg border-2 transition-all duration-300 ${
                                    isDarkMode
                                        ? 'bg-gradient-to-r from-green-900/50 to-green-800/50 border-green-600'
                                        : 'bg-gradient-to-r from-green-50 to-green-100/50 border-green-200'
                                }`
                            },
                                React.createElement('div', { className: `flex items-center ${isRTL ? 'flex-row-reverse' : ''} space-x-3 ${isRTL ? 'space-x-reverse' : ''} mb-3` },
                                    React.createElement('div', { 
                                        className: 'w-8 h-8 bg-gradient-to-br from-green-400 to-emerald-500 rounded-full flex items-center justify-center shadow-md'
                                    },
                                        React.createElement(CheckIcon, { className: 'w-5 h-5 text-white' })
                                    ),
                                    React.createElement('h3', { 
                                        className: `text-lg font-bold transition-colors duration-300 ${isRTL ? 'text-right' : 'text-left'} ${
                                            isDarkMode ? 'text-slate-300' : 'text-slate-700'
                                        }`
                                    }, exercise.name)
                                ),
                                
                                React.createElement('div', { className: `flex ${isRTL ? 'justify-start flex-row-reverse' : 'justify-end'} space-x-3 ${isRTL ? 'space-x-reverse' : ''}` },
                                    React.createElement('div', { 
                                        className: `flex items-center space-x-2 ${isRTL ? 'space-x-reverse flex-row-reverse' : ''} px-3 py-2 rounded-xl shadow-sm ${
                                            isDarkMode ? 'bg-purple-900/50' : 'bg-purple-100'
                                        }`
                                    },
                                        React.createElement(StackIcon, { 
                                            className: `w-4 h-4 ${isDarkMode ? 'text-purple-400' : 'text-purple-600'}`
                                        }),
                                        React.createElement('span', { 
                                            className: `font-bold text-sm ${
                                                isDarkMode ? 'text-purple-300' : 'text-purple-800'
                                            }`
                                        }, `${finalValues.sets}`)
                                    ),
                                    
                                    React.createElement('div', { 
                                        className: `flex items-center space-x-2 ${isRTL ? 'space-x-reverse flex-row-reverse' : ''} px-3 py-2 rounded-xl shadow-sm ${
                                            isDarkMode ? 'bg-orange-900/50' : 'bg-orange-100'
                                        }`
                                    },
                                        React.createElement(DumbbellIcon, { 
                                            className: `w-4 h-4 ${isDarkMode ? 'text-orange-400' : 'text-orange-600'}`
                                        }),
                                        React.createElement('span', { 
                                            className: `font-bold text-sm ${
                                                isDarkMode ? 'text-orange-300' : 'text-orange-800'
                                            }`
                                        }, `${formatWeight(finalValues.weight)}kg`)
                                    ),
                                    
                                    React.createElement('div', { 
                                        className: `flex items-center space-x-2 ${isRTL ? 'space-x-reverse flex-row-reverse' : ''} px-3 py-2 rounded-xl shadow-sm ${
                                            isDarkMode ? 'bg-blue-900/50' : 'bg-blue-100'
                                        }`
                                    },
                                        React.createElement(RepeatIcon, { 
                                            className: `w-4 h-4 ${isDarkMode ? 'text-blue-400' : 'text-blue-600'}`
                                        }),
                                        React.createElement('span', { 
                                            className: `font-bold text-sm ${
                                                isDarkMode ? 'text-blue-300' : 'text-blue-800'
                                            }`
                                        }, `${finalValues.reps}x`)
                                    )
                                )
                            );
                        })
                    )
                );
            }

            // Main Workout Screen
            return (
                <div className={`min-h-screen p-3 transition-all duration-500 ${
                    isDarkMode 
                        ? 'bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900' 
                        : 'bg-gradient-to-br from-indigo-50 via-white to-pink-50'
                }`} onClick={editingExercise ? finishEditing : undefined}>
                    {/* Header */}
                    {React.createElement('div', { className: 'text-center mb-6' },
                        React.createElement('h1', { 
                            className: `text-4xl font-bold bg-gradient-to-r bg-clip-text text-transparent transition-all duration-500 mb-4 ${
                                isDarkMode 
                                    ? 'from-blue-400 to-purple-400' 
                                    : 'from-indigo-600 to-pink-600'
                            }`
                        }, 'GymBuddy'),
                        
                        // Routine Selector
                        React.createElement('div', { className: 'mb-4' },
                            React.createElement('div', { 
                                className: `inline-flex rounded-full p-1 transition-all duration-300 ${
                                    isDarkMode 
                                        ? 'bg-slate-800/80 border border-slate-600/50' 
                                        : 'bg-white/80 border border-gray-200/50'
                                } backdrop-blur-sm shadow-lg`
                            },
                                Object.entries(ROUTINE_CONFIGS).map(([routineId, config]) => 
                                    React.createElement('button', {
                                        key: routineId,
                                        onClick: () => switchRoutine(routineId),
                                        className: `flex flex-col items-center justify-center px-4 py-3 rounded-full transition-all duration-300 min-w-[80px] ${
                                            currentRoutine === routineId
                                                ? isDarkMode 
                                                    ? 'bg-indigo-600 text-white shadow-md' 
                                                    : 'bg-indigo-500 text-white shadow-md'
                                                : isDarkMode 
                                                    ? 'text-slate-400 hover:text-slate-200 hover:bg-slate-700/50' 
                                                    : 'text-slate-600 hover:text-slate-800 hover:bg-gray-100/50'
                                        }`
                                    },
                                        React.createElement('span', { className: 'text-lg mb-1' }, config.icon),
                                        React.createElement('span', { className: 'text-xs font-medium' }, config.label)
                                    )
                                )
                            )
                        ),
                        
                        React.createElement('div', { className: `flex justify-center ${isRTL ? 'flex-row-reverse' : ''} space-x-3 ${isRTL ? 'space-x-reverse' : ''}` },
                            React.createElement('button', {
                                onClick: () => setCurrentView('history'),
                                className: `px-6 py-2 rounded-full text-sm font-medium transition-all duration-300 ${
                                    isDarkMode 
                                        ? 'bg-indigo-600 text-white hover:bg-indigo-500 shadow-lg hover:shadow-xl' 
                                        : 'bg-indigo-500 text-white hover:bg-indigo-600 shadow-lg hover:shadow-xl'
                                } transform hover:scale-105`
                            }, 'Show History'),
                            React.createElement('button', {
                                onClick: () => setCurrentView('editProgram'),
                                className: `px-6 py-2 rounded-full text-sm font-medium transition-all duration-300 ${
                                    isDarkMode 
                                        ? 'bg-purple-600 text-white hover:bg-purple-500 shadow-lg hover:shadow-xl' 
                                        : 'bg-purple-500 text-white hover:bg-purple-600 shadow-lg hover:shadow-xl'
                                } transform hover:scale-105`
                            },
                                React.createElement('div', { className: `flex items-center ${isRTL ? 'flex-row-reverse' : ''} space-x-1 ${isRTL ? 'space-x-reverse' : ''}` },
                                    React.createElement(EditIcon, { className: 'w-4 h-4' }),
                                    React.createElement('span', {}, 'Edit Program')
                                )
                            )
                        )
                    )}

                    {React.createElement('div', { className: 'max-w-lg mx-auto grid grid-cols-1 gap-3' },
                        currentExercises.map((exercise, index) => {
                            const isCompleted = completedExercises.has(index);
                            const isBeingEdited = editingExercise?.index === index;
                            const shouldDarken = editingExercise && !isBeingEdited;
                            const currentValues = exerciseValues[index] || { sets: exercise.sets, weight: exercise.weight, reps: exercise.reps };

                            if (isBeingEdited) {
                                const editingType = editingExercise.type;
                                const range = getValueRange(editingExercise.original, editingType);
                                
                                return React.createElement('div', { 
                                    key: index,
                                    className: `rounded-2xl p-6 shadow-lg border-2 transition-all duration-300 relative z-10 ${
                                        isDarkMode
                                            ? 'bg-slate-800 border-blue-500'
                                            : 'bg-white border-indigo-300'
                                    }`,
                                    onClick: (e) => e.stopPropagation()
                                },
                                    React.createElement('div', { className: 'text-center space-y-6' },
                                        React.createElement('h3', { 
                                            className: `text-lg font-bold ${isDarkMode ? 'text-white' : 'text-slate-800'}`
                                        }, exercise.name),
                                        
                                        React.createElement('div', { className: 'space-y-4' },
                                            React.createElement('div', { className: 'h-8 flex justify-center items-end' },
                                                React.createElement('div', { 
                                                    className: `px-3 py-1 rounded-lg text-sm font-bold ${
                                                        editingType === 'sets' 
                                                            ? isDarkMode ? 'bg-purple-700 text-purple-100' : 'bg-purple-500 text-white'
                                                            : editingType === 'weight' 
                                                                ? isDarkMode ? 'bg-orange-700 text-orange-100' : 'bg-orange-500 text-white'
                                                                : isDarkMode ? 'bg-blue-700 text-blue-100' : 'bg-blue-500 text-white'
                                                    }`
                                                }, `${editingType === 'weight' ? formatWeight(editingExercise.value) : editingExercise.value}${
                                                    editingType === 'weight' ? 'kg' : editingType === 'reps' ? 'x' : ''
                                                }`)
                                            ),
                                            
                                            React.createElement('div', { className: 'relative px-4' },
                                                React.createElement('input', {
                                                    type: 'range',
                                                    min: range.min,
                                                    max: range.max,
                                                    step: range.step,
                                                    value: editingExercise.value,
                                                    onChange: (e) => updateEditValue(parseFloat(e.target.value)),
                                                    className: 'w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer slider'
                                                })
                                            )
                                        )
                                    )
                                );
                            }

                            return React.createElement('div', {
                                key: index,
                                className: `rounded-2xl p-4 shadow-lg border-2 transition-all duration-300 hover:scale-[1.02] ${
                                    shouldDarken ? 'opacity-30 cursor-pointer' : ''
                                } ${
                                    isCompleted 
                                        ? isDarkMode
                                            ? 'bg-gradient-to-r from-green-900/50 to-green-800/50 border-green-600 opacity-75'
                                            : 'bg-gradient-to-r from-green-50 to-green-100/50 border-green-200 opacity-75'
                                        : isDarkMode
                                            ? 'bg-slate-800/80 hover:border-slate-600 hover:shadow-xl border-slate-700 hover:bg-slate-800/90'
                                            : 'bg-white hover:border-indigo-200 hover:shadow-xl border-indigo-100 bg-gradient-to-r from-white to-indigo-50/30'
                                }`,
                                onClick: shouldDarken ? finishEditing : (e) => e.stopPropagation()
                            },
                                React.createElement('div', { className: `flex items-center ${isRTL ? 'flex-row-reverse' : ''} space-x-3 ${isRTL ? 'space-x-reverse' : ''} mb-3` },
                                    React.createElement('div', { 
                                        onClick: (e) => {
                                            if (!shouldDarken) {
                                                e.stopPropagation();
                                                toggleExercise(index);
                                            }
                                        },
                                        className: 'w-8 h-8 bg-gradient-to-br from-green-400 to-emerald-500 rounded-full flex items-center justify-center shadow-md cursor-pointer hover:scale-110 transition-transform duration-200'
                                    },
                                        isCompleted 
                                            ? React.createElement(CheckIcon, { className: 'w-5 h-5 text-white' })
                                            : React.createElement('div', { className: 'w-3 h-3 bg-white rounded-full' })
                                    ),
                                    
                                    React.createElement('h3', { 
                                        className: `text-lg font-bold transition-colors duration-300 ${isRTL ? 'text-right' : 'text-left'} ${
                                            isCompleted 
                                                ? isDarkMode ? 'text-slate-400' : 'text-slate-600'
                                                : isDarkMode ? 'text-white' : 'text-slate-800'
                                        }`
                                    }, exercise.name)
                                ),
                                
                                React.createElement('div', { className: `flex ${isRTL ? 'justify-start flex-row-reverse' : 'justify-end'} space-x-3 ${isRTL ? 'space-x-reverse' : ''}` },
                                    React.createElement('div', { 
                                        className: `flex items-center space-x-2 ${isRTL ? 'space-x-reverse flex-row-reverse' : ''} px-3 py-2 rounded-xl shadow-sm transition-colors duration-300 cursor-pointer hover:scale-105 ${
                                            isDarkMode ? 'bg-purple-900/50 hover:bg-purple-800/60' : 'bg-purple-100 hover:bg-purple-200'
                                        }`,
                                        onMouseDown: (e) => {
                                            if (!shouldDarken) {
                                                e.stopPropagation();
                                                const timer = setTimeout(() => startEditing(index, 'sets'), 500);
                                                e.target._longPressTimer = timer;
                                            }
                                        },
                                        onMouseUp: (e) => {
                                            e.stopPropagation();
                                            if (e.target._longPressTimer) {
                                                clearTimeout(e.target._longPressTimer);
                                            }
                                        },
                                        onTouchStart: (e) => {
                                            if (!shouldDarken) {
                                                e.preventDefault();
                                                e.stopPropagation();
                                                const timer = setTimeout(() => startEditing(index, 'sets'), 500);
                                                e.target._longPressTimer = timer;
                                            }
                                        },
                                        onTouchEnd: (e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            if (e.target._longPressTimer) {
                                                clearTimeout(e.target._longPressTimer);
                                            }
                                        }
                                    },
                                        React.createElement(StackIcon, { 
                                            className: `w-4 h-4 ${isDarkMode ? 'text-purple-400' : 'text-purple-600'}`
                                        }),
                                        React.createElement('span', { 
                                            className: `font-bold text-sm transition-colors duration-300 ${
                                                isDarkMode ? 'text-purple-300' : 'text-purple-800'
                                            }`
                                        }, currentValues.sets !== exercise.sets 
                                            ? `${currentValues.sets}/${exercise.sets}`
                                            : `${currentValues.sets}`
                                        )
                                    ),
                                    
                                    React.createElement('div', { 
                                        className: `flex items-center space-x-2 ${isRTL ? 'space-x-reverse flex-row-reverse' : ''} px-3 py-2 rounded-xl shadow-sm transition-colors duration-300 cursor-pointer hover:scale-105 ${
                                            isDarkMode ? 'bg-orange-900/50 hover:bg-orange-800/60' : 'bg-orange-100 hover:bg-orange-200'
                                        }`,
                                        onMouseDown: (e) => {
                                            if (!shouldDarken) {
                                                e.stopPropagation();
                                                const timer = setTimeout(() => startEditing(index, 'weight'), 500);
                                                e.target._longPressTimer = timer;
                                            }
                                        },
                                        onMouseUp: (e) => {
                                            e.stopPropagation();
                                            if (e.target._longPressTimer) {
                                                clearTimeout(e.target._longPressTimer);
                                            }
                                        },
                                        onTouchStart: (e) => {
                                            if (!shouldDarken) {
                                                e.preventDefault();
                                                e.stopPropagation();
                                                const timer = setTimeout(() => startEditing(index, 'weight'), 500);
                                                e.target._longPressTimer = timer;
                                            }
                                        },
                                        onTouchEnd: (e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            if (e.target._longPressTimer) {
                                                clearTimeout(e.target._longPressTimer);
                                            }
                                        }
                                    },
                                        React.createElement(DumbbellIcon, { 
                                            className: `w-4 h-4 ${isDarkMode ? 'text-orange-400' : 'text-orange-600'}`
                                        }),
                                        React.createElement('span', { 
                                            className: `font-bold text-sm transition-colors duration-300 ${
                                                isDarkMode ? 'text-orange-300' : 'text-orange-800'
                                            }`
                                        }, currentValues.weight !== exercise.weight 
                                            ? `${formatWeight(currentValues.weight)}/${formatWeight(exercise.weight)}kg`
                                            : `${formatWeight(currentValues.weight)}kg`
                                        )
                                    ),
                                    
                                    React.createElement('div', { 
                                        className: `flex items-center space-x-2 ${isRTL ? 'space-x-reverse flex-row-reverse' : ''} px-3 py-2 rounded-xl shadow-sm transition-colors duration-300 cursor-pointer hover:scale-105 ${
                                            isDarkMode ? 'bg-blue-900/50 hover:bg-blue-800/60' : 'bg-blue-100 hover:bg-blue-200'
                                        }`,
                                        onMouseDown: (e) => {
                                            if (!shouldDarken) {
                                                e.stopPropagation();
                                                const timer = setTimeout(() => startEditing(index, 'reps'), 500);
                                                e.target._longPressTimer = timer;
                                            }
                                        },
                                        onMouseUp: (e) => {
                                            e.stopPropagation();
                                            if (e.target._longPressTimer) {
                                                clearTimeout(e.target._longPressTimer);
                                            }
                                        },
                                        onTouchStart: (e) => {
                                            if (!shouldDarken) {
                                                e.preventDefault();
                                                e.stopPropagation();
                                                const timer = setTimeout(() => startEditing(index, 'reps'), 500);
                                                e.target._longPressTimer = timer;
                                            }
                                        },
                                        onTouchEnd: (e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            if (e.target._longPressTimer) {
                                                clearTimeout(e.target._longPressTimer);
                                            }
                                        }
                                    },
                                        React.createElement(RepeatIcon, { 
                                            className: `w-4 h-4 ${isDarkMode ? 'text-blue-400' : 'text-blue-600'}`
                                        }),
                                        React.createElement('span', { 
                                            className: `font-bold text-sm transition-colors duration-300 ${
                                                isDarkMode ? 'text-blue-300' : 'text-blue-800'
                                            }`
                                        }, currentValues.reps !== exercise.reps 
                                            ? `${currentValues.reps}/${exercise.reps}x`
                                            : `${currentValues.reps}x`
                                        )
                                    )
                                )
                            );
                        })
                    )}

                    {React.createElement('div', { 
                        className: `max-w-lg mx-auto mt-6 rounded-xl p-4 border transition-all duration-300 ${
                            isDarkMode 
                                ? 'bg-slate-800/60 backdrop-blur-sm border-slate-600/50' 
                                : 'bg-white/60 backdrop-blur-sm border-white/50'
                        }`,
                        onClick: editingExercise ? finishEditing : undefined
                    },
                        React.createElement('div', { className: 'text-center' },
                            React.createElement('div', { 
                                className: `font-bold text-lg transition-colors duration-300 ${
                                    isDarkMode ? 'text-slate-200' : 'text-slate-700'
                                }`
                            }, `${completedCount} of ${currentExercises.length} exercises completed`),
                            
                            React.createElement('div', { 
                                className: `w-full rounded-full h-2 mt-2 transition-colors duration-300 ${
                                    isDarkMode ? 'bg-slate-700' : 'bg-gray-200'
                                }`
                            },
                                React.createElement('div', { 
                                    className: 'bg-gradient-to-r from-green-400 to-emerald-500 h-2 rounded-full transition-all duration-500',
                                    style: { width: `${(completedCount / currentExercises.length) * 100}%` }
                                })
                            )
                        )
                    )}

                    {React.createElement('div', { 
                        className: 'max-w-lg mx-auto mt-4 flex justify-center',
                        onClick: editingExercise ? finishEditing : undefined
                    },
                        React.createElement('div', { 
                            className: `flex items-center ${isRTL ? 'flex-row-reverse' : ''} space-x-3 ${isRTL ? 'space-x-reverse' : ''} px-4 py-2 rounded-full transition-all duration-300 ${
                                isDarkMode 
                                    ? 'bg-slate-800/60 backdrop-blur-sm border border-slate-600/50' 
                                    : 'bg-white/60 backdrop-blur-sm border border-white/50'
                            }`,
                            onClick: (e) => {
                                e.stopPropagation();
                                if (!editingExercise) toggleDarkMode();
                            }
                        },
                            React.createElement('span', { 
                                className: `text-sm transition-colors duration-300 ${
                                    isDarkMode ? 'text-slate-300' : 'text-slate-600'
                                }`
                            }, 'â˜€ï¸'),
                            
                            React.createElement('button', {
                                onClick: (e) => {
                                    e.stopPropagation();
                                    if (!editingExercise) toggleDarkMode();
                                },
                                className: `relative w-12 h-6 rounded-full transition-all duration-300 focus:outline-none ${
                                    isDarkMode ? 'bg-blue-600' : 'bg-gray-300'
                                }`
                            },
                                React.createElement('div', { 
                                    className: `absolute top-1 ${isRTL ? 'right-1' : 'left-1'} w-4 h-4 rounded-full bg-white shadow-md transition-transform duration-300 ${
                                        isDarkMode ? (isRTL ? 'transform -translate-x-6' : 'transform translate-x-6') : ''
                                    }`
                                })
                            ),
                            
                            React.createElement('span', { 
                                className: `text-sm transition-colors duration-300 ${
                                    isDarkMode ? 'text-slate-300' : 'text-slate-600'
                                }`
                            }, 'ðŸŒ™')
                        )
                    )}

                    {React.createElement('div', { 
                        className: 'text-center mt-4 space-y-2',
                        onClick: editingExercise ? finishEditing : undefined
                    },
                        React.createElement('div', { 
                            className: `text-sm transition-colors duration-300 ${
                                isDarkMode ? 'text-slate-400' : 'text-slate-400'
                            }`
                        }, 'Your workout companion'),
                        
                        React.createElement('div', { className: `flex items-center justify-center ${isRTL ? 'flex-row-reverse' : ''} space-x-3 ${isRTL ? 'space-x-reverse' : ''}` },
                            React.createElement('span', { 
                                className: `inline-block text-xs px-3 py-1 rounded-full shadow-sm backdrop-blur-sm transition-all duration-300 ${
                                    isDarkMode 
                                        ? 'text-slate-400 bg-slate-800/70' 
                                        : 'text-slate-400 bg-white/70'
                                }`
                            }, 'v1.6.0'),
                            
                            sessionHistory.length > 0 && React.createElement('span', { 
                                className: `text-xs px-2 py-1 rounded-full transition-all duration-300 ${
                                    isDarkMode ? 'bg-indigo-900/50 text-indigo-300' : 'bg-indigo-100 text-indigo-600'
                                }`
                            }, `ðŸ“… ${sessionHistory.length} sessions`),
                            
                            saveStatus && React.createElement('span', { 
                                className: `text-xs px-2 py-1 rounded-full transition-all duration-300 ${
                                    saveStatus === 'saving' ? 'bg-blue-100 text-blue-600' :
                                    saveStatus === 'saved' ? 'bg-green-100 text-green-600' :
                                    saveStatus === 'error' ? 'bg-red-100 text-red-600' : ''
                                }`
                            }, 
                                saveStatus === 'saving' ? 'ðŸ’¾ Saving...' :
                                saveStatus === 'saved' ? 'âœ… Saved' :
                                saveStatus === 'error' ? 'âŒ Error' : ''
                            )
                        )
                    )}
                </div>
            );
        };

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(GymBuddy));
    </script>
</body>
</html>
